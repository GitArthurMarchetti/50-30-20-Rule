generator client {
  provider      = "prisma-client-js"
  output        = "../app/generated/prisma"
  binaryTargets = ["native"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                     Int      @id @default(autoincrement())
  username               String   @unique
  email                  String   @unique
  password_hash          String
  previous_month_balance Decimal? @db.Decimal(10, 2)

  transactions        Transaction[]
  pendingTransactions PendingTransaction[]
  summaries           MonthlySummary[]
  categories          Category[]

  @@map("users")
}

enum TransactionType {
  ROLLOVER
  INCOME
  NEEDS
  WANTS
  RESERVES
  INVESTMENTS
}

model Category {
  id     Int    @id @default(autoincrement())
  name   String
  
  type   TransactionType
  
  userId Int
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  transactions        Transaction[]
  pendingTransactions PendingTransaction[]

  @@unique([userId, name, type])
  @@map("categories")
}
model Transaction {
  id          Int             @id @default(autoincrement())
  description String
  amount      Decimal         @db.Decimal(10, 2)
  date        DateTime        @default(now())
  type        TransactionType

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  categoryId Int? 
  
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@unique([id, userId]) 
  @@map("transactions")
}

model PendingTransaction {
  id          Int             @id @default(autoincrement())
  description String
  amount      Decimal         @db.Decimal(10, 2)
  date        DateTime        @default(now())
  type        TransactionType

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  categoryId Int?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  expiresAt  DateTime        @default(now())
  isDuplicate Boolean?
  rawData    String?

  @@index([userId, expiresAt])
  @@map("pending_transactions")
}

model MonthlySummary {
  id                Int      @id @default(autoincrement())
  month_year        DateTime @db.Date
  total_income      Decimal  @db.Decimal(10, 2)
  needs_expenses    Decimal  @db.Decimal(10, 2)
  wants_expenses    Decimal  @db.Decimal(10, 2)
  total_savings     Decimal  @db.Decimal(10, 2)
  total_investments Decimal  @db.Decimal(10, 2)
  final_balance     Decimal  @db.Decimal(10, 2)

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month_year])
  @@map("monthly_summaries")
}

